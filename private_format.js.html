

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: private/format.js | Source: private/format.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
        
            <link type="text/css" rel="stylesheet" href="custom.css">
        
    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="">
        
            <img src="img/toast-ui.png" width="100%" height="100%">
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Source: private/format.js</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
        <ol class="lnb-tab">
            <li id="api-tab">
                <a href="#"><h4>API</h4></a>
            </li>
            <li id="examples-tab">
                <a href="#"><h4>Examples</h4></a>
            </li>
        </ol>
    
    <div class="lnb-examples hidden"><h3>Examples</h3><ul><li><a href="tutorial-colorful-statusbar.html">A colorful statusbar</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="colorful-statusbar_sub"></div></li><li><a href="tutorial-formats.html">File formats</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="formats_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-hedit.html">hedit</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:hedit_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-hedit.html#.emitKeys">emitKeys</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="module-hedit.html#~event:load">load</a></li><li><a href="module-hedit.html#~event:modeSwitch">modeSwitch</a></li><li><a href="module-hedit.html#~event:quit">quit</a></li><li><a href="module-hedit.html#~event:viewSwitch">viewSwitch</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-hedit.html#~CommandCallback">CommandCallback</a></li><li><a href="module-hedit.html#~OptionCallback">OptionCallback</a></li></ul></div></li><li><a href="module-hedit_file.html">hedit/file</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:hedit/file_sub"><div class="member-type">Events</div><ul class="inner"><li><a href="module-hedit_file.html#~event:beforeWrite">beforeWrite</a></li><li><a href="module-hedit_file.html#~event:close">close</a></li><li><a href="module-hedit_file.html#~event:open">open</a></li><li><a href="module-hedit_file.html#~event:write">write</a></li></ul></div></li><li><a href="module-hedit_log.html">hedit/log</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:hedit/log_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-hedit_log.html#~debug">debug</a></li><li><a href="module-hedit_log.html#~error">error</a></li><li><a href="module-hedit_log.html#~fatal">fatal</a></li><li><a href="module-hedit_log.html#~info">info</a></li><li><a href="module-hedit_log.html#~warn">warn</a></li></ul></div></li><li><a href="module-hedit_statusbar.html">hedit/statusbar</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:hedit/statusbar_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-hedit_statusbar.html#.hideMessage">hideMessage</a></li><li><a href="module-hedit_statusbar.html#.showMessage">showMessage</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="EventEmitter.html">EventEmitter</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EventEmitter_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EventEmitter.html#emit">emit</a></li><li><a href="EventEmitter.html#eventNames">eventNames</a></li><li><a href="EventEmitter.html#listenerCount">listenerCount</a></li><li><a href="EventEmitter.html#listeners">listeners</a></li><li><a href="EventEmitter.html#on">on</a></li><li><a href="EventEmitter.html#once">once</a></li><li><a href="EventEmitter.html#removeAllListeners">removeAllListeners</a></li><li><a href="EventEmitter.html#removeListener">removeListener</a></li></ul></div></li><li><a href="FileProxy.html">FileProxy</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FileProxy_sub"></div></li><li><a href="Format.html">Format</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Format_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#allFormats">allFormats</a></li><li><a href="global.html#guessLookup">guessLookup</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import file from 'hedit/file';
import log from 'hedit/log';

// Color names to integers map.
const COLORS = {
    white: 0,
    gray: 1,
    blue: 2,
    red: 3,
    pink: 4,
    green: 5,
    purple: 6,
    orange: 7
};

const LINEARIZE = Symbol('linearize');

// Helper function to join two optional strings
function join(a, b) {
    if (a &amp;&amp; b) {
        return a + ' > ' + b;
    } else {
        return a ? a : b;
    }
}

/**
 * A Format represents a description of the binary structure of a file.
 * @see For a list of the builtin formats, check [the source](https://github.com/95ulisse/hedit/tree/master/src/js/format).
 */
export class Format {

    /**
     * Format constructor.
     */
    constructor(proxy) {
        this._proxy = proxy;
        this._segments = [];
    }

    array(name, length, child = 'white') {
        const repeat = typeof length === 'string' ? data => 0 + data[length] : length;

        if (child instanceof Format) {

            // A composite child
            this._segments.push({
                child: {
                    *[LINEARIZE](absoffset, basename, variables) {
                        const n = typeof repeat === 'function' ? repeat(variables) : repeat;
                        let offset = absoffset;
                        for (let i = 0; i &lt; n; i++) {
                            for (let childseg of child[LINEARIZE](offset, join(basename, name), Object.create(variables))) {
                                yield childseg;
                                offset = childseg.to + 1;
                            }
                        }
                    }
                }
            });

        } else if (typeof child === 'string') {

            // Shortcut for a simple array of bytes
            this._segments.push({
                child: {
                    *[LINEARIZE](absoffset, basename, variables) {
                        const n = typeof repeat === 'function' ? repeat(variables) : repeat;
                        if (n > 0) {
                            yield {
                                name: join(basename, name),
                                color: COLORS[child],
                                from: absoffset,
                                to: absoffset + n - 1
                            };
                        }
                    }
                }
            });

        }

        return this;
    }

    child(name, c) {
        if (typeof c === 'undefined') {
            c = name;
            name = null;
        }
        return this.array(name, 1, c);
    }

    sequence(name, c) {
        if (typeof c === 'undefined') {
            c = name;
            name = null;
        }
        return this.array(name, Infinity, c);
    }

    group(name) {
        const childFormat = new Format();
        childFormat._parent = this;
        this.child(name, childFormat);
        return childFormat;
    }

    endgroup() {
        const parent = this._parent;
        if (!parent) {
            throw new Error('Unbalanced group()/endgroup() calls.');
        }
        delete this._parent;
        return parent;
    }

    *[LINEARIZE](absoffset, basename, variables) {

        if (this._parent) {
            throw new Error('Unbalanced group()/endgroup() calls.');
        }

        let offset = absoffset;

        // Iterate over all the segments computing the actual absolute offsets
        for (let seg of this._segments) {
            if (seg.child) {
                for (let childseg of seg.child[LINEARIZE](offset, join(basename, seg.name), Object.create(variables))) {
                    yield childseg;
                    offset = childseg.to + 1;
                }
            } else if (seg.length > 0) {
                if (seg.id) {
                    variables[seg.id] = seg.read(this._proxy, offset);
                }
                yield {
                    name: join(basename, seg.name),
                    color: COLORS[seg.color],
                    from: offset,
                    to: offset + seg.length - 1
                };
                offset += seg.length;
            }
        }

    }

    [Symbol.iterator]() {
        return this[LINEARIZE](0, '', Object.create(null));
    }
};


function addCommonMethod(name, length, m, endianess) {
    if (endianess) {
        
        // Generate two methods for the little and big endian version
        Format.prototype[name + 'le'] = function (name, color = 'white', id) {
            this._segments.push({
                name,
                color,
                length,
                id,
                read(proxy, off) {
                    return m.call(new DataView(proxy.read(off, length)), 0, true /* Little endian */);
                }
            });
            return this;
        };
        Format.prototype[name + 'be'] = function (name, color = 'white', id) {
            this._segments.push({
                name,
                color,
                length,
                id,
                read(proxy, off) {
                    return m.call(new DataView(proxy.read(off, length)), 0, false /* Big endian */);
                }
            });
            return this;
        };
 
        // Name without endianess specification defaults to big endian
        Format.prototype[name] = Format.prototype[name + 'be'];

    } else {

        // Generate a single method regardless of the endianess
        Format.prototype[name] = function (name, color = 'white', id) {
            this._segments.push({
                name,
                color,
                length,
                id,
                read(proxy, off) {
                    return m.call(new DataView(proxy.read(off, length)), 0);
                }
            });
            return this;
        };

    }
}

addCommonMethod('int8',     1,  DataView.prototype.getInt8,     false);
addCommonMethod('uint8',    1,  DataView.prototype.getUint8,    false);
addCommonMethod('int16',    2,  DataView.prototype.getInt16,    true );
addCommonMethod('uint16',   2,  DataView.prototype.getUint16,   true );
addCommonMethod('int32',    4,  DataView.prototype.getInt32,    true );
addCommonMethod('uint32',   4,  DataView.prototype.getUint32,   true );
addCommonMethod('float32',  4,  DataView.prototype.getFloat32,  true );
addCommonMethod('float64',  8,  DataView.prototype.getFloat64,  true );



/** A reverse lookup to provide fast automatic guesses of file formats. */
const guessLookup = {
    extension: {},
    magic: [],
    maxMagicLength: 0
};

function storeGuess(name, guess) {
    if (guess) {
        if (guess.extension) {
            guessLookup.extension[guess.extension] = name;
        }
        if (guess.magic) {
            const m = guess.magic.buffer ? new Uint8Array(guess.magic.buffer) : guess.magic;
            guessLookup.magic.push([ m, name ]);
            guessLookup.maxMagicLength = Math.max(guessLookup.maxMagicLength, m.byteLength);
        }
    }
}

/**
 * Map of all the registered formats.
 * The values are thunks, so that the builtin formats are evaluated only if required.
 */
const allFormats = {};

/** Proxy class that records and aggregates the access to the underlying file data. */
class FileProxy {
    read(offset, len) {
        const val = file.read(offset, len);
        log.info(`Read caught: [${offset}, ${offset + len - 1}] => ${new Uint8Array(val)}`);
        return val;
    }
}

export default {

    registerBuiltinFormat(formats) {
        for (let k in formats) {
            allFormats[k] = () => __hedit.require('hedit/format/' + k).default;
            storeGuess(k, formats[k]);
        }
    },

    registerFormat(name, guess, desc) {
        // No duplicate names allowed
        if (allFormats[name]) {
            throw new Error('Duplicate format name: ' + name);
        }

        allFormats[name] = () => desc;
        storeGuess(name, guess);
    },

    // This function will be called by the native code when we need to make
    // a first guess on a freshly opened file.
    guessFormat() {

        // First try with the magic
        if (guessLookup.maxMagicLength > 0) {
            const magic = new Uint8Array(file.read(0, guessLookup.maxMagicLength));
            for (let [ k, name ] of guessLookup.magic) {
                if (k.byteLength &lt;= magic.byteLength) {
                    let eq = true;
                    for (let i = 0; i &lt; k.byteLength; i++) {
                        if (k[i] != magic[i]) {
                            eq = false;
                            break;
                        }
                    }
                    if (eq) {
                        log.debug('Guessing format ' + name + ' for matching magic.');
                        return name;
                    }
                }
            }
        }

        // Then with the extension
        const name = file.name;
        if (name) {
            const ext = name.match(/\.\w+$/);
            if (ext &amp;&amp; ext[0]) {
                const formatName = guessLookup.extension[ext[0].substring(1)];
                if (formatName) {
                    log.debug('Guessing format ' + formatName + ' for matching extension.');
                    return formatName;
                }
            }
        }

        return 'none';

    },

    // This function is called evey time the `:set` option `format` changes.
    setFormat(name) {
        const format = allFormats[name];
        if (!format) {
            log.error(`Unknown format ${name}.`);
            return;
        }

        let f = format();
        if (typeof f === 'function') {
            f = f(new FileProxy());
        }

        if (!(f instanceof Format)) {
            log.error('Formats must be an instance of the Format class, or functions returning a Format.');
            return;
        }

        __hedit.file_setFormat(f);
    }

};</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="img/toast-ui.png" style="">
    <div class="footer-text">NHN Entertainment. Frontend Development Lab</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
